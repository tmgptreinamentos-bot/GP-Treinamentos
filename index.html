<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GP Treinamentos — catálogo</title>
<style>
:root{
  --bg1:#000; --bg2:#222; --card:#111; --gold:#d4af37; --border:#333; --text:#fff;
}
body{
  margin:0; font-family:Inter,Arial,sans-serif; background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text); padding:18px;
}
.container{max-width:920px;margin:0 auto;}
h1{color:var(--gold);text-align:center;margin-bottom:18px;}
.card{background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border); margin-bottom:22px;}
label{color:var(--gold);font-weight:600;margin-bottom:6px;display:block;}
input{width:100%;padding:11px;border-radius:8px;border:1px solid var(--border);background:#222;color:var(--text);margin-bottom:12px;}
button{width:100%;padding:13px;border-radius:10px;border:none;background:var(--gold);color:#000;font-weight:700;font-size:16px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-top:8px;}
.item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;height:160px;}
.item img{width:100%;height:100%;object-fit:cover;border-radius:8px;}
.item input[type="checkbox"]{position:absolute;right:8px;top:8px;transform:scale(1.35);}
#btnSolicitar{margin-top:18px;background:var(--gold);color:#000;padding:14px;border-radius:10px;font-size:18px;}
.small-note{color:#bbb;font-size:13px;margin-top:8px;text-align:center;}
</style>
</head>
<body>
<div class="container">
  <h1>GP Treinamentos</h1>

  <div class="card">
    <label>Nome</label>
    <input id="nome" type="text" placeholder="Seu nome">
    <label>Telefone</label>
    <input id="telefone" type="text" placeholder="(xx) xxxxx-xxxx">
    <label>E-mail</label>
    <input id="email" type="email" placeholder="seu@exemplo.com">
    <button onclick="salvarDados()">Salvar dados</button>
    <div class="small-note">Salve seus dados antes de solicitar PDFs.</div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <button id="btnSolicitar" onclick="solicitar()">Solicitar PDFs selecionados</button>
  <div id="status" class="small-note"></div>
</div>

<script>
const WEBAPP = "https://script.google.com/macros/s/AKfycbzAQozrqKD_zwMbAZY4cPU_tpsPYVk1Wsp6Z2JM4D9o8c3tNAbgKUftaU6rmQWoIZvO/exec";

// Converter vários formatos de URL do Drive para uma URL direta (lh3) usada nos <img>
function toDirectImageURL(raw) {
  if (!raw) return null;
  // se já for lh3, retorna direto
  if (raw.includes("lh3.googleusercontent.com")) return raw;
  // formato uc?export=view&id=ID
  let m = raw.match(/uc\?export=view&id=([-\w]+)/);
  if (m && m[1]) return `https://lh3.googleusercontent.com/d/${m[1]}=s1000`;
  // formato file/d/ID/view...
  m = raw.match(/\/file\/d\/([-\w]+)/);
  if (m && m[1]) return `https://lh3.googleusercontent.com/d/${m[1]}=s1000`;
  // formato share link with id in url
  m = raw.match(/[-\w]{25,}/);
  if (m && m[0]) return `https://lh3.googleusercontent.com/d/${m[0]}=s1000`;
  // fallback: retorna original (talvez funcione)
  return raw;
}

// Ler campo independente de maiúsculas (nome da propriedade pode variar)
function getField(obj, names){
  for(const n of names){
    if(obj[n] !== undefined) return obj[n];
  }
  return null;
}

async function carregar(){
  try {
    const res = await fetch(WEBAPP); // o doGet retorna array de objetos
    const dados = await res.json();
    console.log("Dados recebidos do WebApp:", dados); // => abra o console para inspecionar
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    dados.forEach(item => {
      // pega nome/imagem/pdf independentemente de chave maiúscula
      const nome = getField(item, ["nome","Nome","title","curso"]) || "";
      const rawImg = getField(item, ["imagem","Imagem","image","img"]) || "";
      const pdf = getField(item, ["pdf","PDF","Pdf","file"]) || "";

      const imgUrl = toDirectImageURL(rawImg);
      console.log("imgUrl gerada:", imgUrl, "pdf:", pdf);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <input type="checkbox" value="${pdf}">
        <img src="${imgUrl || 'https://via.placeholder.com/400x300?text=Sem+Imagem'}" 
             onerror="this.src='https://via.placeholder.com/400x300?text=Sem+Imagem'">
      `;
      grid.appendChild(div);
    });
  } catch (err) {
    console.error("Erro ao carregar cursos:", err);
    document.getElementById("grid").innerHTML = "<div style='color:#f88'>Erro ao carregar cursos — veja console.</div>"
  }
}

function salvarDados(){
  const n = document.getElementById("nome").value.trim();
  const t = document.getElementById("telefone").value.trim();
  const e = document.getElementById("email").value.trim();
  if(!n || !e){ alert("Preencha ao menos nome e e-mail antes de salvar."); return; }
  localStorage.setItem("gp_nome", n);
  localStorage.setItem("gp_telefone", t);
  localStorage.setItem("gp_email", e);
  alert("Dados salvos localmente.");
}

async function solicitar(){
  const nome = localStorage.getItem("gp_nome");
  const telefone = localStorage.getItem("gp_telefone") || "";
  const email = localStorage.getItem("gp_email");
  if(!nome || !email){ alert("Salve nome e e-mail antes de solicitar."); return; }

  const checked = [...document.querySelectorAll("#grid input[type=checkbox]:checked")].map(i => i.value).filter(Boolean);
  if(checked.length===0){ alert("Selecione ao menos um curso."); return; }

  // montar payload compatível com seu doPost
  const payload = { action: "solicitar", nome, telefone, email, pdfs: checked };
  try {
    // NOTE: pode dar CORS; o Apps Script aceita POST normalmente se publicado.
    await fetch(WEBAPP, { method: "POST", headers:{ 'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    document.getElementById("status").innerText = "Solicitação enviada! Verifique seu e-mail.";
  } catch(err){
    console.error("erro ao enviar:", err);
    document.getElementById("status").innerText = "Erro ao enviar. Veja console.";
  }
}

// inicializa
carregar();
</script>
</body>
</html>
